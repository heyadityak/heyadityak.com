{{- if .Page.HasShortcode "mermaid" | or (findRE "```mermaid" .Page.RawContent) -}}
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const isDark = document.documentElement.classList.contains('dark');
    
    // Store original source before mermaid processes them
    document.querySelectorAll('.mermaid').forEach((el) => {
      el.setAttribute('data-mermaid-src', el.textContent.trim());
    });
    
    // Initialize mermaid
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      securityLevel: 'loose',
      fontFamily: 'ui-sans-serif, system-ui, sans-serif'
    });
    
    // Run mermaid on all diagrams
    mermaid.run({
      nodes: document.querySelectorAll('.mermaid')
    });
    
    // Watch for theme changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          const isDark = document.documentElement.classList.contains('dark');
          
          // Re-render all diagrams with new theme
          document.querySelectorAll('.mermaid').forEach(async (el) => {
            const code = el.getAttribute('data-mermaid-src');
            if (code) {
              el.innerHTML = code;
              el.removeAttribute('data-processed');
            }
          });
          
          mermaid.initialize({
            startOnLoad: false,
            theme: isDark ? 'dark' : 'default',
            securityLevel: 'loose',
            fontFamily: 'ui-sans-serif, system-ui, sans-serif'
          });
          
          mermaid.run({
            nodes: document.querySelectorAll('.mermaid')
          });
        }
      });
    });
    
    observer.observe(document.documentElement, { attributes: true });
  });
</script>
{{- end -}}
