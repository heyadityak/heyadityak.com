{{ if and .Site.Params.utterances.repo (not hugo.IsServer) }}
<div class="mt-12 pt-8 border-t border-gray-200 dark:border-dark-border">
  <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Comments</h3>
  <script src="https://utteranc.es/client.js"
    repo="{{ .Site.Params.utterances.repo }}"
    issue-term="{{ .Site.Params.utterances.issueTerm | default "pathname" }}"
    {{ with .Site.Params.utterances.label }}label="{{ . }}"{{ end }}
    theme="{{ .Site.Params.utterances.theme | default "github-light" }}"
    crossorigin="anonymous"
    async>
  </script>
</div>

<!-- Dark mode theme switcher for utterances -->
<script>
  function setUtterancesTheme(theme) {
    const utterancesFrame = document.querySelector('.utterances-frame');
    if (utterancesFrame) {
      const message = {
        type: 'set-theme',
        theme: theme === 'dark' ? '{{ .Site.Params.utterances.themeDark | default "github-dark" }}' : '{{ .Site.Params.utterances.theme | default "github-light" }}'
      };
      utterancesFrame.contentWindow.postMessage(message, 'https://utteranc.es');
    }
  }

  // Watch for theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        const isDark = document.documentElement.classList.contains('dark');
        setUtterancesTheme(isDark ? 'dark' : 'light');
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });

  // Set initial theme after utterances loads
  window.addEventListener('message', (event) => {
    if (event.origin !== 'https://utteranc.es') return;
    const isDark = document.documentElement.classList.contains('dark');
    setUtterancesTheme(isDark ? 'dark' : 'light');
  });
</script>
{{ end }}
